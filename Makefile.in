#
# Makefile.in/Makefile, build rules for pseudo
#
# Copyright (c) 2008-2010 Wind River Systems, Inc.
#
# This program is free software; you can redistribute it and/or modify
# it under the terms of the Lesser GNU General Public License version 2.1 as
# published by the Free Software Foundation.
#
# This program is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.
# See the Lesser GNU General Public License for more details.
#
# You should have received a copy of the Lesser GNU General Public License
# version 2.1 along with this program; if not, write to the Free Software
# Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA 02111-1307 USA 
#

# configuration flags
PREFIX=@PREFIX@
SUFFIX=@SUFFIX@
SQLITE=@SQLITE@
BITS=@BITS@
MARK64=@MARK64@
VERSION=0.3

LIB=lib$(MARK64)
BIN=bin
LOCALSTATE=var/pseudo
LIBDIR=$(PREFIX)/$(LIB)
BINDIR=$(PREFIX)/$(BIN)
LOCALSTATEDIR=$(PREFIX)/$(LOCALSTATE)

CFLAGS_BASE=-pipe -std=gnu99 -Wall -W -Wextra
CFLAGS_CODE=-fPIC -D_LARGEFILE64_SOURCE -D_ATFILE_SOURCE -m$(BITS)
CFLAGS_DEFS=-DPSEUDO_PREFIX='"$(PREFIX)"' -DPSEUDO_SUFFIX='"$(SUFFIX)"' -DPSEUDO_VERSION='"$(VERSION)"'
CFLAGS_DEBUG=-O2 -g
CFLAGS_SQL=-L$(SQLITE)/lib -I$(SQLITE)/include
CFLAGS=$(CFLAGS_BASE) $(CFLAGS_CODE) $(CFLAGS_DEFS) \
	$(CFLAGS_DEBUG) $(CFLAGS_SQL)

GLOB_PATTERN=guts/*.c
GUTS=$(filter-out "$(GLOB_PATTERN)",$(wildcard $(GLOB_PATTERN)))

DBLDFLAGS=-lsqlite3
USE_64=wrapfuncs64.in

SHOBJS=pseudo_table.o pseudo_util.o
DBOBJS=pseudo_db.o -ldl -lpthread
WRAPOBJS=pseudo_wrappers.o

PSEUDO=$(BIN)/pseudo
PSEUDODB=$(BIN)/pseudodb
PSEUDOLOG=$(BIN)/pseudolog
LIBPSEUDO=$(LIB)/libpseudo$(SUFFIX).so


all: $(LIBPSEUDO) $(PSEUDO) $(PSEUDODB) $(PSEUDOLOG)

test: all $(BIN) $(LIB) $(LOCALSTATE)
	@./run_tests.sh

install-lib: $(LIBPSEUDO)
	mkdir -p $(DESTDIR)$(LIBDIR)
	cp $(LIBPSEUDO) $(DESTDIR)$(LIBDIR)

install-bin: $(PSEUDO) $(PSEUDODB) $(PSEUDOLOG)
	mkdir -p $(DESTDIR)$(BINDIR)
	cp $(PSEUDO) $(PSEUDODB) $(PSEUDOLOG) $(DESTDIR)$(BINDIR)

install-data:
	mkdir -p $(DESTDIR)$(LOCALSTATEDIR)

install: all install-lib install-bin install-data

$(BIN) $(LIB) $(LOCALSTATE):
	mkdir -p $@

$(PSEUDO): $(BIN) pseudo.o $(SHOBJS) $(DBOBJS) pseudo_client.o pseudo_server.o pseudo_ipc.o
	$(CC) $(CFLAGS) -o $(PSEUDO) \
		pseudo.o pseudo_server.o pseudo_client.o pseudo_ipc.o \
		$(DBOBJS) $(SHOBJS) $(DBLDFLAGS)

$(PSEUDOLOG): $(BIN) pseudolog.o $(SHOBJS) $(DBOBJS) pseudo_client.o pseudo_ipc.o
	$(CC) $(CFLAGS) -o $(PSEUDOLOG) pseudolog.o pseudo_client.o pseudo_ipc.o \
		$(DBOBJS) $(SHOBJS) $(DBLDFLAGS)

$(PSEUDODB): $(BIN) pseudodb.o $(SHOBJS) $(DBOBJS) pseudo_ipc.o
	$(CC) $(CFLAGS) -o $(PSEUDODB) pseudodb.o \
		$(DBOBJS) $(SHOBJS) $(DBLDFLAGS) pseudo_ipc.o

$(LIBPSEUDO): $(LIB) $(WRAPOBJS) pseudo_client.o pseudo_ipc.o $(SHOBJS)
	$(CC) $(CFLAGS) -shared -o $(LIBPSEUDO) \
		pseudo_client.o pseudo_ipc.o \
		$(WRAPOBJS) $(SHOBJS) -ldl

pseudo_client.o pseudo_server.o pseudo_ipc.o: pseudo_ipc.h

pseudo_client.o: pseudo_client.h

pseudo_server.o: pseudo_server.h

wrappers: wrapfuncs.in $(USE_64) makewrappers
	./makewrappers wrapfuncs.in $(USE_64)

.SECONDARY: wrappers

pseudo_wrapfuncs.c pseudo_wrapfuncs.h: wrappers

# no-strict-aliasing is needed for the function pointer trickery.
pseudo_wrappers.o: $(GUTS) pseudo_wrappers.c pseudo_wrapfuncs.c pseudo_wrapfuncs.h
	$(CC) -fno-strict-aliasing $(CFLAGS) -D_GNU_SOURCE -c -o pseudo_wrappers.o pseudo_wrappers.c

offsets32:
	$(CC) -m32 -o offsets32 offsets.c

offsets64:
	$(CC) -m64 -o offsets64 offsets.c

clean:
	rm -f *.o *.so $(PSEUDO) $(PSEUDODB) $(PSEUDOLOG) \
		pseudo_wrapfuncs.h pseudo_wrapfuncs.c \
		pseudo_wrapper_table.c \
		pseudo_wrapfuncs.c.old pseudo_wrapfuncs.h.old \
		offsets32 offsets64

distclean: clean
	rm -f Makefile
	rm -rf ./$(BIN) ./$(LIB) ./$(LOCALSTATE)
	@echo "WARNING: Makefile has been removed.  You must reconfigure to do anything else."

nuke: distclean
	case "$(PREFIX)" in "`pwd`"/*) rm -rf "$(PREFIX)";; esac
	@echo "WARNING: Removed $(PREFIX)."
